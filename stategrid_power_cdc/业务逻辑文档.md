# 国网电力实时数仓业务逻辑文档

## 一、业务背景

### 1.1 业务概述
国网电力实时数仓项目基于 Flink 2.2.0 + Fluss 0.8.0 构建，实现电力数据的实时采集、处理、分析和展示。系统采用数仓分层架构（ODS→DWD→DWS→ADS），支持实时负荷监控、智能计量、用电分析等核心业务场景。

### 1.2 业务价值
- **实时监控**：秒级响应各区域电力负荷变化
- **精准分析**：通过多维度聚合支持业务决策
- **智能服务**：用户用电排名、峰值时段识别
- **数据驱动**：为电力调度、需求响应提供数据支撑

---

## 二、数据源说明

### 2.1 用户信息表 (power_user)
记录电力用户的基本信息和用电属性。

| 字段 | 类型 | 业务含义 | 说明 |
|------|------|----------|------|
| user_id | BIGINT | 用户ID | 主键，用户唯一标识 |
| user_name | STRING | 用户姓名 | |
| usage_type | STRING | 用电类型 | 如：居民/工业/商业/农业 |
| region_id | INT | 区域ID | 用户所属供电区域 |
| region_name | STRING | 区域名称 | 供电区域名称 |
| address | STRING | 用户地址 | |
| phone | STRING | 联系电话 | |
| create_time | TIMESTAMP(3) | 创建时间 | 用户建档时间 |
| update_time | TIMESTAMP(3) | 更新时间 | 信息最后更新时间 |

### 2.2 消费记录表 (power_consumption)
记录用户每次电表读数和用电情况。

| 字段 | 类型 | 业务含义 | 说明 |
|------|------|----------|------|
| consumption_id | BIGINT | 消费记录ID | 主键 |
| user_id | BIGINT | 用户ID | 关联用户信息 |
| consumption_amount | DECIMAL(10,2) | 用电量 | 单位：千瓦时(kWh) |
| consumption_cost | DECIMAL(10,2) | 用电费用 | 单位：元 |
| consumption_date | TIMESTAMP(3) | 用电时间 | 计费时间点 |
| meter_reading_before | DECIMAL(10,2) | 上次读数 | 电表读数 |
| meter_reading_after | DECIMAL(10,2) | 本次读数 | 电表读数 |
| remark | STRING | 备注 | 异常记录说明等 |

---

## 三、数仓分层设计

### 3.1 整体架构

```
DataGen (实时数据生成)
        ↓
    [ODS层 - 原始数据层]
  ├── ods_power_user (用户信息)
  └── ods_power_consumption (消费记录)
        ↓ Join
    [DWD层 - 明细数据层]
  └── dwd_power_consumption_detail (消费明细)
        ↓ Aggregate (5秒窗口)
    [DWS层 - 汇总数据层]
  ├── dws_region_daily_stats (地区汇总)
  └── dws_user_ranking (用户排名)
        ↓ Transform
    [ADS层 - 应用数据层]
  └── ads_power_dashboard (仪表盘数据)
        ↓ JDBC Sink
PostgreSQL (数据服务)
```

### 3.2 分层职责

| 分层 | 职责 | 主要操作 | 数据量级 |
|------|------|----------|----------|
| ODS | 原始数据存储 | CDC/DataGen 同步 | 大 |
| DWD | 明细数据清洗 | 维度关联、字段补充 | 中 |
| DWS | 指标聚合统计 | 多维度聚合、排名计算 | 小 |
| ADS | 应用数据输出 | 面向报表/仪表盘的数据组织 | 小 |

---

## 四、分层业务逻辑详解

### 4.1 ODS 层（原始数据层）

#### 4.1.1 用户信息同步 (ods_power_user)
**业务逻辑**：
- 使用 DataGen 持续生成用户信息
- 每秒生成 1 条用户记录
- user_id 使用 sequence 自增，范围 1-1000

**技术实现**：
```sql
CREATE TABLE power_user_source (
    user_id BIGINT,
    user_name STRING,
    usage_type STRING,
    region_id INT,
    region_name STRING,
    ...
) WITH (
    'connector' = 'datagen',
    'rows-per-second' = '1',
    'fields.user_id.kind' = 'sequence',
    'fields.user_id.start' = '1',
    'fields.region_id.min' = '1',
    'fields.region_id.max' = '10'  -- 模拟10个供电区域
);
```

#### 4.1.2 消费记录同步 (ods_power_consumption)
**业务逻辑**：
- 使用 DataGen 持续生成消费记录
- 每秒生成 5 条消费记录
- 消费时间在过去 2.4 小时内随机分布 (max-past = '0.1d')
- 模拟实时电表读数上报

**技术实现**：
```sql
CREATE TABLE power_consumption_source (
    consumption_id BIGINT,
    user_id BIGINT,
    consumption_amount DECIMAL(10,2),
    consumption_date TIMESTAMP(3),
    ...
) WITH (
    'connector' = 'datagen',
    'rows-per-second' = '5',
    'fields.consumption_date.kind' = 'random',
    'fields.consumption_date.max-past' = '0.1d'
);
```

---

### 4.2 DWD 层（明细数据层）

#### 4.2.1 消费明细关联 (dwd_power_consumption_detail)
**业务逻辑**：
- 将消费记录与用户信息进行维度关联
- 补充用户姓名、区域、用电类型等维度信息
- 记录 ETL 处理时间，便于数据质量监控

**关联规则**：
```sql
SELECT
    c.consumption_id,
    c.user_id,
    COALESCE(u.user_name, '未知用户') AS user_name,
    c.consumption_amount,
    c.consumption_cost,
    c.consumption_date,
    COALESCE(u.region_id, 0) AS region_id,
    COALESCE(u.region_name, '未知地区') AS region_name,
    COALESCE(u.usage_type, '未知') AS usage_type,
    CURRENT_TIMESTAMP AS etl_time
FROM ods_power_consumption AS c
LEFT JOIN ods_power_user AS u
    ON c.user_id = u.user_id;
```

**业务意义**：
- 将分散的用户和消费数据整合为完整的消费明细
- 为后续聚合分析提供丰富的维度信息
- 支持 LEFT JOIN 保留无用户信息的异常消费记录

**Watermark 配置**：
```sql
WATERMARK FOR consumption_date AS consumption_date - INTERVAL '5' SECOND
```
- 基于消费时间生成水位线
- 允许 5 秒延迟，应对网络传输延迟

---

### 4.3 DWS 层（汇总数据层）

#### 4.3.1 地区实时汇总 (dws_region_daily_stats)
**业务逻辑**：
- 每 5 秒滚动窗口聚合各区域用电指标
- 计算区域用电总量、总费用、用户数、平均用电量、峰值、谷值

**聚合指标**：
| 指标 | 计算逻辑 | 业务含义 |
|------|----------|----------|
| total_consumption | SUM(consumption_amount) | 区域总用电量 |
| total_cost | SUM(consumption_cost) | 区域总电费 |
| user_count | COUNT(DISTINCT user_id) | 用电用户数 |
| avg_consumption | ROUND(AVG(consumption_amount), 2) | 人均用电量 |
| max_consumption | MAX(consumption_amount) | 单次最高用电量 |
| min_consumption | MIN(consumption_amount) | 单次最低用电量 |

**技术实现**：
```sql
INSERT INTO dws_region_daily_stats
SELECT
    region_id,
    region_name,
    CAST(TUMBLE_START(consumption_date, INTERVAL '5' SECOND) AS TIMESTAMP(3)) AS stat_date,
    SUM(consumption_amount) AS total_consumption,
    SUM(consumption_cost) AS total_cost,
    COUNT(DISTINCT user_id) AS user_count,
    ROUND(AVG(consumption_amount), 2) AS avg_consumption,
    MAX(consumption_amount) AS max_consumption,
    MIN(consumption_amount) AS min_consumption
FROM dwd_power_consumption_detail
GROUP BY
    region_id,
    region_name,
    TUMBLE(consumption_date, INTERVAL '5' SECOND);
```

**业务场景**：
- 供电所实时监控各区域用电负荷
- 识别用电高峰区域，及时调配电力资源
- 用户增长分析、用电成本分析

#### 4.3.2 用户用电排名 (dws_user_ranking)
**业务逻辑**：
- 每 5 秒窗口按区域统计用户用电量
- 计算用户用电排名（从高到低）
- 支持区域间用户用电对比

**排名逻辑**：
```sql
SELECT
    t1.user_id,
    t1.user_name,
    t1.region_id,
    t1.region_name,
    t1.stat_date,
    t1.total_consumption,
    t1.total_cost,
    t2.total_count - t1.row_num_asc + 1 AS ranking
FROM (
    SELECT
        user_id,
        user_name,
        region_id,
        region_name,
        stat_date,
        total_consumption,
        total_cost,
        ROW_NUMBER() OVER (
            PARTITION BY stat_date, region_id
            ORDER BY total_consumption ASC
        ) AS row_num_asc
    FROM (
        -- 按用户、地区、时间窗口聚合用电量
    )
) t1
LEFT JOIN (
    SELECT
        stat_date,
        region_id,
        COUNT(*) AS total_count
    FROM (...)
    GROUP BY stat_date, region_id
) t2 ON t1.stat_date = t2.stat_date AND t1.region_id = t2.region_id;
```

**业务场景**：
- 识别高耗能用户，提供节能建议
- VIP 用户识别与服务优化
- 用电异常用户监控（排名突增/突减）

---

### 4.4 ADS 层（应用数据层）

#### 4.4.1 电力仪表盘数据 (ads_power_dashboard)
**业务逻辑**：
- 整合 DWS 层的地区汇总和用户排名数据
- 计算各地区峰值用电时段
- 输出面向仪表盘的综合指标

**数据结构**：
| 字段 | 来源 | 业务含义 |
|------|------|----------|
| dashboard_id | 生成 | 仪表盘数据ID：DASHBOARD_{region_id}_{stat_date} |
| stat_date | DWS | 统计时间窗口 |
| region_id | DWS | 区域ID |
| region_name | DWS | 区域名称 |
| total_consumption | DWS | 区域总用电量 |
| total_cost | DWS | 区域总电费 |
| user_count | DWS | 用电用户数 |
| avg_consumption | DWS | 人均用电量 |
| peak_hour | 计算 | 峰值用电小时（0-23） |
| peak_consumption | DWS | 峰值用电量 |
| top_user_id | DWS | 用电量最高用户ID |
| top_user_name | DWS | 用电量最高用户名 |
| top_user_consumption | DWS | 最高用户用电量 |
| update_time | 当前 | 数据更新时间 |

**峰值小时计算逻辑**：
```sql
LEFT JOIN (
    SELECT
        region_id,
        stat_date,
        peak_hour
    FROM (
        SELECT
            region_id,
            CAST(TUMBLE_START(consumption_date, INTERVAL '5' SECOND) AS TIMESTAMP(3)) AS stat_date,
            EXTRACT(HOUR FROM consumption_date) AS peak_hour,
            SUM(consumption_amount) AS hourly_consumption,
            ROW_NUMBER() OVER (
                PARTITION BY region_id, stat_date
                ORDER BY SUM(consumption_amount) DESC
            ) AS rn
        FROM dwd_power_consumption_detail
        GROUP BY
            region_id,
            EXTRACT(HOUR FROM consumption_date),
            TUMBLE(consumption_date, INTERVAL '5' SECOND)
    )
    WHERE rn = 1
) p ON r.region_id = p.region_id AND r.stat_date = p.stat_date;
```

**业务场景**：
- 实时监控大屏展示
- 调度员决策支持
- 电力负荷预测
- 供电质量评估

---

## 五、关键业务指标体系

### 5.1 区域维度指标

| 指标名称 | 指标ID | 计算公式 | 更新频率 |
|----------|--------|----------|----------|
| 区域总用电量 | REGION_TOTAL_CONS | SUM(consumption_amount) | 5秒 |
| 区域总电费 | REGION_TOTAL_COST | SUM(consumption_cost) | 5秒 |
| 用电用户数 | REGION_USER_COUNT | COUNT(DISTINCT user_id) | 5秒 |
| 人均用电量 | REGION_AVG_CONS | AVG(consumption_amount) | 5秒 |
| 区域峰值小时 | REGION_PEAK_HOUR | EXTRACT(HOUR FROM max_hour) | 5秒 |

### 5.2 用户维度指标

| 指标名称 | 指标ID | 计算公式 | 更新频率 |
|----------|--------|----------|----------|
| 用户用电量 | USER_TOTAL_CONS | SUM(consumption_amount) | 5秒 |
| 用户电费 | USER_TOTAL_COST | SUM(consumption_cost) | 5秒 |
| 用户排名 | USER_RANKING | RANK() OVER (ORDER BY total_consumption DESC) | 5秒 |

### 5.3 综合指标

| 指标名称 | 指标ID | 业务含义 |
|----------|--------|----------|
| TOP用户 | TOP_USER | 区域内用电量最高的用户 |
| 峰值用电量 | PEAK_CONS | 区域内单次最高用电量 |
| 峰值时段 | PEAK_HOUR | 区域用电量最高的时间段 |

---

## 六、实时处理特性

### 6.1 数据更新频率
- **数据生成**：5 条/秒（消费记录）
- **窗口聚合**：5 秒滚动窗口
- **指标刷新**：每 5 秒更新一次 DWS/ADS 指标

### 6.2 延迟特性
- **水位线延迟**：5 秒（允许网络传输延迟）
- **端到端延迟**：< 10 秒（从数据生成到指标产出）
- **Checkpoint 间隔**：10 秒（容错恢复）

### 6.3 数据新鲜度
- 数据在生成后 10 秒内完成全链路处理
- 仪表盘数据实时反映当前电力负荷情况

---

## 七、业务场景示例

### 7.1 场景一：实时负荷监控
**需求**：监控各区域实时用电负荷，识别超负荷区域

**实现**：
- 查询 `ads_power_dashboard` 表
- 按 `total_consumption` 降序排列
- 设置告警阈值（如超过 50000 kWh）

```sql
SELECT
    region_name,
    total_consumption,
    peak_hour,
    update_time
FROM ads_power_dashboard
WHERE total_consumption > 50000
ORDER BY total_consumption DESC;
```

### 7.2 场景二：高耗能用户识别
**需求**：识别区域内用电量 Top 10 用户，提供节能建议

**实现**：
- 查询 `dws_user_ranking` 表
- 按 `ranking` 过滤（排名 ≤ 10）
- 关联用户联系方式

```sql
SELECT
    region_name,
    user_name,
    total_consumption,
    total_cost
FROM dws_user_ranking
WHERE ranking <= 10
ORDER BY region_id, ranking;
```

### 7.3 场景三：用电高峰分析
**需求**：分析各地区用电高峰时段，优化电力调度

**实现**：
- 查询 `ads_power_dashboard` 表
- 按 `peak_hour` 分组统计
- 生成热力图

```sql
SELECT
    peak_hour AS hour,
    COUNT(*) AS region_count,
    SUM(peak_consumption) AS total_peak_cons
FROM ads_power_dashboard
WHERE DATE(update_time) = CURRENT_DATE
GROUP BY peak_hour
ORDER BY total_peak_cons DESC;
```

### 7.4 场景四：用户增长监控
**需求**：监控各地区用户数增长趋势

**实现**：
- 查询 `dws_region_daily_stats` 表
- 按 `stat_date` 时间序列分析
- 计算环比增长率

```sql
SELECT
    region_name,
    stat_date,
    user_count,
    LAG(user_count) OVER (PARTITION BY region_id ORDER BY stat_date) AS prev_user_count,
    (user_count - LAG(user_count) OVER (PARTITION BY region_id ORDER BY stat_date)) * 100.0 / LAG(user_count) OVER (PARTITION BY region_id ORDER BY stat_date) AS growth_rate
FROM dws_region_daily_stats
WHERE stat_date >= CURRENT_TIMESTAMP - INTERVAL '1' HOUR
ORDER BY region_id, stat_date;
```

---

## 八、性能指标

### 8.1 吞吐量
- **数据摄入**：5 条/秒（消费记录）+ 1 条/秒（用户信息）
- **数据处理**：> 1000 TPS
- **指标产出**：每 5 秒产出 10 个区域的聚合结果

### 8.2 延迟
- **端到端延迟**：< 10 秒
- **窗口延迟**：5 秒（滚动窗口）
- **水位线延迟**：5 秒

### 8.3 可用性
- **Checkpoint 成功率**：> 99%
- **作业重启时间**：< 30 秒
- **数据丢失率**：0%（Exactly Once 语义）

---

## 九、扩展业务场景

### 9.1 实时负荷预测
基于历史数据 + 实时数据，预测未来 1 小时内各区域用电负荷

### 9.2 智能计量
智能电表数据实时采集，支持实时计费、异常检测

### 9.3 需求响应
根据实时负荷情况，触发需求响应策略（如错峰用电）

### 9.4 分布式能源
整合太阳能、风能等分布式能源数据，优化能源调度

### 9.5 故障预警
基于用电模式分析，预测设备故障风险

---

## 十、技术实现要点

### 10.1 数据一致性保障
- **Watermark**：基于事件时间处理，乱序容忍 5 秒
- **Checkpoint**：10 秒间隔，确保 Exactly Once 语义
- **主键约束**：Fluss 分桶键必须是主键子集

### 10.2 并发控制
- **并行度**：默认 2（可调整）
- **分桶策略**：按主键分桶，避免数据倾斜
- **窗口策略**：滚动窗口，数据清晰划分

### 10.3 容错机制
- **状态后端**：RocksDB（持久化到磁盘）
- **Checkpoint 目录**：`file:///tmp/flink-checkpoints`
- **重试机制**：Sink 失败最多重试 3 次

---

## 十一、数据质量

### 11.1 数据完整性
- 用户信息缺失时标记为"未知用户"
- 区域信息缺失时标记为"未知地区"

### 11.2 数据准确性
- 时间戳精确到毫秒
- 金额保留 2 位小数
- 排名算法确保正确性

### 11.3 数据及时性
- 5 秒窗口聚合，数据延迟 < 10 秒
- Watermark 允许 5 秒乱序数据

---

## 十二、运维监控

### 12.1 作业监控
- **Flink Web UI**：http://localhost:8081
- **作业状态**：RUNNING/FAILED/CANCELED
- **Checkpoint 状态**：成功率/耗时

### 12.2 性能监控
- **端到端延迟**：监控数据从生成到 Sink 的总耗时
- **吞吐量**：每秒处理的记录数
- **背压情况**：各算子处理速度

### 12.3 数据监控
- **数据量监控**：各层数据条数对比
- **数据完整性**：主键重复检查
- **数据新鲜度**：最新数据时间戳

---

## 附录 A：SQL 文件映射

| SQL 文件 | 分层 | 业务逻辑 |
|----------|------|----------|
| 01-run-ods-cdc.sql | ODS | DataGen 数据同步到 Fluss |
| 02-run-dwd-transform.sql | DWD | 用户-消费明细关联 |
| 03-run-dws-aggregate.sql | DWS | 5秒窗口聚合+用户排名 |
| 04-run-ads-transform.sql | ADS | 仪表盘数据组装 |
| 05-run-fluss-to-postgres.sql | Sink | 数据写入 PostgreSQL |

---

## 附录 B：表结构总结

### Fluss 分层表

| 表名 | 分层 | 主键 | 分桶键 | 更新频率 |
|------|------|------|--------|----------|
| ods_power_user | ODS | user_id | user_id | 1条/秒 |
| ods_power_consumption | ODS | consumption_id | consumption_id | 5条/秒 |
| dwd_power_consumption_detail | DWD | consumption_id | consumption_id | 5条/秒 |
| dws_region_daily_stats | DWS | region_id, stat_date | region_id | 5秒 |
| dws_user_ranking | DWS | user_id, stat_date | user_id | 5秒 |
| ads_power_dashboard | ADS | dashboard_id, stat_date, region_id | dashboard_id | 5秒 |

### PostgreSQL Sink 表

| 表名 | 用途 |
|------|------|
| ads_power_dashboard | 仪表盘数据输出 |

---

## 附录 C：术语表

| 术语 | 解释 |
|------|------|
| ODS | Operational Data Store，操作数据层，存储原始数据 |
| DWD | Data Warehouse Detail，数据仓库明细层，清洗、关联后的明细数据 |
| DWS | Data Warehouse Summary，数据仓库汇总层，多维度聚合数据 |
| ADS | Application Data Store，应用数据层，面向应用的数据输出 |
| CDC | Change Data Capture，变更数据捕获，实时捕获数据库变更 |
| Watermark | 水位线，流处理中用于处理乱序数据的时间标记 |
| Tumble | 滚动窗口，固定大小、不重叠的时间窗口 |
| Row_Number | 行编号函数，用于计算排名 |

---

## 附录 D：参考资料

- [Flink 2.2.0 文档](https://nightlies.apache.org/flink/flink-docs-release-2.2/)
- [Fluss 0.8.0 文档](https://fluss.apache.org/)
- [国网电力业务规范](内部文档)

---

**文档版本**：v1.0
**更新日期**：2026-01-15
**维护人员**：数据平台团队
