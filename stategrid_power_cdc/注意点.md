# Fluss 分层表分桶键配置注意点

## 核心规则

**Fluss 主键表（含 `PRIMARY KEY` 定义）的分桶键（`bucket.key`）必须是主键的子集。**

## 错误示例

```sql
CREATE TABLE ods_power_consumption (
    consumption_id BIGINT,
    user_id BIGINT,
    ...
    PRIMARY KEY (consumption_id) NOT ENFORCED  -- 主键是 consumption_id
) WITH (
    'bucket.key' = 'user_id',  -- ❌ 错误：user_id 不是主键的子集
    'table.delete.behavior' = 'IGNORE'
);
```

**错误信息：**
```
Bucket keys must be a subset of primary keys excluding partition keys.
The primary keys are [consumption_id], partition keys are [],
but user-defined bucket keys are [user_id].
```

## 正确配置

### 方案1：使用主键作为分桶键（推荐）

```sql
CREATE TABLE ods_power_consumption (
    consumption_id BIGINT,
    user_id BIGINT,
    ...
    PRIMARY KEY (consumption_id) NOT ENFORCED
) WITH (
    'bucket.key' = 'consumption_id',  -- ✅ 正确：使用主键字段
    'table.delete.behavior' = 'IGNORE'
);
```

### 方案2：使用复合主键

如果业务需要按 `user_id` 分桶，可以修改主键为复合主键：

```sql
CREATE TABLE ods_power_consumption (
    consumption_id BIGINT,
    user_id BIGINT,
    ...
    PRIMARY KEY (user_id, consumption_id) NOT ENFORCED  -- 复合主键
) WITH (
    'bucket.key' = 'user_id',  -- ✅ 正确：user_id 是主键的子集
    'table.delete.behavior' = 'IGNORE'
);
```

## 本项目配置汇总

| 表名 | 主键 | 分桶键 | 状态 |
|------|------|--------|------|
| `ods_power_user` | `user_id` | `user_id` | ✅ 正确 |
| `ods_power_consumption` | `consumption_id` | `consumption_id` | ✅ 已修复 |
| `dwd_power_consumption_detail` | `consumption_id` | `consumption_id` | ✅ 已修复 |
| `dws_region_daily_stats` | `region_id, stat_date` | `region_id` | ✅ 正确 |
| `dws_user_ranking` | `user_id, stat_date` | `user_id` | ✅ 正确 |
| `ads_power_dashboard` | `dashboard_id, stat_date, region_id` | `dashboard_id` | ✅ 已修复 |

## 为什么需要这个限制？

1. **数据一致性**：同一主键的更新/删除操作必须路由到同一个桶，避免数据分散到多个桶导致不一致。
2. **性能优化**：按主键分桶可以更高效地进行主键查找和更新操作。
3. **CDC 语义支持**：Flink CDC 需要主键来支持 upsert/delete 语义。

## 常见场景

### 场景1：CDC 同步表
- **推荐**：使用源表主键作为分桶键
- **原因**：CDC 场景下，主键是数据的唯一标识，按主键分桶最合理

### 场景2：聚合统计表（DWS层）
- **推荐**：使用维度字段作为分桶键
- **示例**：地区汇总表使用 `region_id`，用户排名表使用 `user_id`
- **原因**：聚合查询通常按维度字段过滤，按维度分桶可以减少数据扫描

### 场景3：关联表（DWD层）
- **推荐**：使用主表主键或关联键作为分桶键
- **示例**：消费明细表使用 `consumption_id`
- **原因**：DWD 层数据通常以 CDC 同步为主键，需要支持 upsert

## 调试建议

1. **检查主键定义**：确保 `PRIMARY KEY` 正确定义
2. **检查分桶键**：确认 `bucket.key` 是主键的子集
3. **查看错误信息**：Fluss 会明确提示主键和分桶键的不匹配

## 参考资料

- Flink 2.2.0 文档：https://nightlies.apache.org/flink/flink-docs-release-2.2/
- Fluss 0.8.0 文档：https://fluss.apache.org/
